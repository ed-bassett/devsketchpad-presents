<%flags>
inherit => undef
</%flags>
<%args>
$session => undef
</%args>
<%once>
use Presents::User qw(get_people);
</%once>
<%init>

my @people = @{get_people()};
our ($user) = grep {lc($_->{'name'}) eq lc($r->user())} @people;

my @tabs = (
	{
		'url'  => q{/index.html},
		'name' => q{My wish list},
	},
	{
		'url'  => q{/add.html},
		'name' => q{Add a gift},
	},
	{
		'url'  => q{/gifts.html},
		'name' => q{Choose gifts},
	},
	{
		'url'  => q{/shopping.html},
		'name' => q{Shopping list},
	},	
);

my $current_tab = eval {$m->comp('REQUEST:tab')};

</%init>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
<title>Presents</title>
<link rel="StyleSheet" href="/assets/style.css" type="text/css" media="screen" />
<script type="text/javascript" src="/assets/javascript/jquery-1.7.min.js"></script>
<script type="text/javascript">
<!--

var pageData;
var pageName = document.URL;

var docParts = {};

$(document).ready(function(){
	try{initialize();} catch(e){}

	//var gap = ( $(window).height() - $('#content').offset().top - 70 );
	//$('#content').css( "height" , gap );

	set_click();
	$('.choose').live('click', function(event){
		event.preventDefault();
		$.get($(this).attr('href'), function() {
			$('#content').load(pageName + ' #content>*');
			//$('#page_gifts_wrapper').load(pageName + ' #page_gifts');
		});
	});
	$('.choice .button').live('click', function(event){
		event.preventDefault();
		$.get($(this).attr('href'), function() {
			$('#content_wrapper').load('/index.html #content');
		});
	});
	$('#like').live('click', function(){
		$('#preference_form .dependant').fadeToggle();
	});	

	$('.controller').live('click', function(){
		var controls = $(this).attr('class').match(/controls_(\S+)/)[1]
		if ( controls )
		{
			$(document).find('.depends_' + controls).slideToggle();
			$(this).toggleClass('collapsed');
		}
	});	
});

function set_click(message)
{
	var activeSubmit;
	$('#all').click(function(e){
		var $link = $(e.target);
		if( $link.is('a[class*="affects_"]') ) {
			if( $link.attr('href') ) {
				e.preventDefault();
				var affects = $link.attr('class').match(/affects_(\S+)/)[1];
				if ( affects === 'parent' )
				{
					affects = $link.parents('.frame').attr('id');
				}
				if( $link.is('a[class*="loads_"]') ) {
					loadPart(
						$link.attr('href'),
						$link.attr('class').match(/loads_(\S+)/)[1],
						affects,
						function(){showPopup();}
					);
				} else {
					loadPart(
						$link.attr('href'),
						affects,
						affects
					);
				}
			}
		}
		else if( $(e.target).is('input') ) {
			activeSubmit=$(e.target);
		}
		
	});
	$('#all').submit(function(e){
		e.preventDefault();
		var form = $(e.target);
		if( form.is('form[class*="affects_"]') )
		{
			//var submit = form.find('input:submit:focus') || activeSubmit;
			var submit = activeSubmit;
			console.log('submit: '+activeSubmit.attr('name'));
			var affects = form.attr('class').match(/affects_(\S+)/)[1];
			if ( affects === 'parent' )
			{
				affects = form.parents('.frame').attr('id');
			}
			if( form.is('form[class*="loads_"]') ) {
				console.log('loads');
				loadPart(
					e.target.action + '?' + $(e.target).serialize() + '&' + submit.attr('name') + '=' + encodeURI(submit.attr('value')),
					form.attr('class').match(/loads_(\S+)/)[1],
					affects
				);
			} else {
				loadPart(
					e.target.action + '?' + $(e.target).serialize() + '&' + submit.attr('name') + '=' + encodeURI(submit.attr('value')),
					affects,
					affects
				);
			}
		}
		return false;	
	});
}

function showPopup()
{
	$('#cover').fadeIn();

	var closeButton = $('<span id="close_popup" class="button">Close</span>');
	closeButton.click(function(){ hidePopup()});
	$('#popup').append(closeButton);
	var gap = ( $(window).height() - $('#popup').height() ) /2;
	$('#popup').css( "margin-top" , gap );
	$('#popup').fadeIn('slow');

	$('#body').fadeTo('normal', .3);
	
}

function hidePopup()
{
	$('#cover').fadeOut();
	$('#popup').fadeOut(function(){
		$('#popup_content').children().remove();
		$('#popup').find('#close_popup').remove();
	});
//THIS IS A HACK, FIX IT
	loadPart(
		'/',
		'content',
		'content'
	);

	$('#body').fadeTo('normal', 1);	
}

function loadPart (location, load_section, fill_section, done)
{
	//document.location = document.location + '#test';
	//document.location = '#'+location.match(/http:\/\/[^\/]*\/(.*)/)[1];
	//docParts[pageName + ' #' + section] = $('#' + section).html();
	pageName=location;
	//$('#' + id).fadeTo('fast', .5);
	if( docParts[location + ' #' + load_section] != null )
	{
		console.log('Cached');
		$('#' + section).empty();
		$('#' + section).prepend(docParts[location + ' #' + fill_section]);
		{
			$('#'+load_section+' div[class*="run_"]').each(function () {
				var funcName = this.className.match(/run_(\S+)/)[1];
				window[funcName]();
			});
		}
	}
	else
	{
		console.log(fill_section);

		$('#' + fill_section).load(
			location + ' #' + load_section + '> *', function(){
				if ( typeof done != "undefined" ) {
					done();
				}
			});
			//function(data){
//				docParts[location + ' #' + section] = $('#' + section).contents();				
				//$.getJSON(
				//	location,
				//	{jquery: true},
				//	function(data){
				//		pageData=data;
				//		$('#'+section+' div[class*="run_"]').each(function () {
				//			var funcName = this.className.match(/run_(\S+)/)[1];
				//			window[funcName]();
				//		});
				//});
				//$('#' + id).fadeTo('fast', 1);
		//});	
	}
}

//-->
</script>
</head>
<body>
<div id="background"></div>
<div id="cover"></div>

<div id="all">
<div id="popup_wrapper">
<div id="popup">
	<div id="popup_content" class="frame"></div>
</div>
</div>
<div id="header">
<div id="id_bar" class="tabs">
	<a class="tab has_action loads_content affects_popup_content" href="/password.html">You are logged in as <strong><% $user->{'name'} |h %></strong></a><a class="tab has_action" href="/logout/">Log out</a>
</div>
<h1>Presents</h1>
</div>
<div id="body" class="frame">
<div id="menu" class="tabs">
% foreach my $tab ( @tabs ) {
<a class="tab has_action<% $tab->{'name'} eq $current_tab ? q{ selected} : q{} %> affects_parent changes_shopping" href="<% $tab->{'url'} |h %>"><% $tab->{'name'} |h %></a>\
% }
</div>
<div id="content_wrapper" >
<div id="content" class="frame clear">
%#<div class="clear"></div>
% 	$m->call_next();
<div class="clear"></div>
</div>
</div>
</div>
</div>
</body>
</html>